import{u as R,r as y,j as q,k as G,c as H,e as C,b as l,w as o,F as K,E as x,d as r,o as Q,g as d,t as j,h as W}from"./index-DXk_WzTb.js";/* empty css                                                 */import{u as X}from"./passurl-By61wUU0.js";import{m as S}from"./Myfetch-B8Qzcl4P.js";const Y={class:"dialog-footer"},Z="zhangsan",ee="123456",de={__name:"MyList",setup(te){const D=R(),{secToken:le,setSecToken:oe,getSecToken:M,clearSecToken:$}=D;let a=null;const m=y(!1),V=y(""),T=y(""),v=y(""),A=X(),{passurl:ne,setPassUrl:F,getPassUrl:se,clearPassUrl:ae}=A,E=W();""+btoa(Z+":"+ee);const U=S,B=M();U.defaults.headers.sec_token=B,console.log("newtoken:"+B),console.log("myfetch:"+U.defaults.headers.sec_token);const w=async()=>{try{const e=(await S.get("/mp4/findAll")).data.map(u=>{const c=JSON.parse(u.urls);//! 断言item.urls不为空且为一个array
const p=[];if(c&&Array.isArray(c)&&c.length>1){c.forEach(n=>{var k,h;const f={x:0,y:0,url:""};let b=n.includes("avc1/")&&((k=n.split("avc1/")[1])==null?void 0:k.split("/")[0])||n.includes("vid/")&&((h=n.split("vid/")[1])==null?void 0:h.split("/")[0]),g=b.split("x")[0],_=b.split("x")[1];//! toint x,y
g=parseInt(g),_=parseInt(_),f.x=g,f.y=_,f.url=n,p.push(f)});let i=p[0];p.forEach(n=>{n.x*n.y>i.x*i.y&&(i=n)});//! 清空item.urls
u.urls="",u.urls=i.url}else console.log("========="),u.urls=c[0];return u});console.log(e),e.sort((u,c)=>new Date(c.createTime)-new Date(u.createTime)),N.value=e}catch(t){console.log(t.status),t.status===401&&(x.error("请重新登录"),$(),E.push({name:"Login"}))}},I=()=>{a&&(a.close(),a=null,console.log("inti==========================================================")),a=new EventSource("http://193.32.148.226:8092/sse/updates"),a?(a.onmessage=t=>{if(console.log(t.data),t.data!="heartbeat"){let e=JSON.parse(t.data);e.id!=0&&(console.log(e.title),x.success("新增成功"),w())}},a.onerror=t=>{console.log("Error occurred:",t);//! 重连
a.close(),a=null;//!30秒后重连
setTimeout(()=>{I()},3e4)},a.onopen=t=>{console.log("Connection opened:",t),console.log("EventSource readyState:",a.readyState)}):console.error("Failed to initialize EventSource")};//! 添加监听error 重连
const O=async(t,e)=>{F(t,e),E.push({name:"MyPlay"})},z=async t=>{console.log(t);try{const e=await S.post("/mp4/deleteById",{id:t});console.log("================="),console.log(e),await w()}catch(e){console.log(e)}},J=async t=>{console.log(t),V.value=t.title,T.value=t.id,m.value=!0},L=async()=>{console.log(T.value),console.log(v.value);try{const t=await S.post("/mp4/updateTitle",{id:T.value,title:v.value});console.log(t),t.status===200?(x.success("更新成功"),m.value=!1,await w()):x.error("更新失败")}catch(t){console.log(t)}};q(()=>{w(),I()}),G(async()=>{try{a.close(),a=null}catch(t){console.error(t)}});const N=y([]);return(t,e)=>{const u=r("el-text"),c=r("el-row"),p=r("el-tag"),i=r("el-table-column"),n=r("el-button"),f=r("el-table"),b=r("el-col"),g=r("el-input"),_=r("el-form-item"),k=r("el-form"),h=r("el-dialog");return Q(),H(K,null,[C("div",null,[l(c,{class:"row-bg",justify:"center"},{default:o(()=>[l(u,null,{default:o(()=>e[3]||(e[3]=[C("h2",{style:{color:"#adff2f"}},"推特视频列表",-1)])),_:1})]),_:1}),l(c,{class:"row-bg",justify:"center"},{default:o(()=>[l(b,{span:24},{default:o(()=>[l(f,{data:N.value,style:{width:"100%"},align:"center"},{default:o(()=>[l(i,{prop:"id",label:"ID",width:"200",align:"center"},{default:o(({row:s})=>[l(p,{type:"success"},{default:o(()=>[d(j(s.id),1)]),_:2},1024)]),_:1}),l(i,{prop:"title",label:"标题",width:"600","show-overflow-tooltip":"",align:"center"},{default:o(({row:s})=>[l(p,{type:"warning"},{default:o(()=>[d(j(s.title),1)]),_:2},1024)]),_:1}),l(i,{prop:"urls",label:"地址",align:"center"},{default:o(({row:s})=>[l(n,{type:"success",plain:"",onClick:P=>O(s.urls,s.title)},{default:o(()=>e[4]||(e[4]=[d(" 播放 ")])),_:2},1032,["onClick"])]),_:1}),l(i,{fixed:"right",label:"更新",width:"100",align:"center"},{default:o(({row:s})=>[l(n,{type:"primary",plain:"",onClick:P=>J(s)},{default:o(()=>e[5]||(e[5]=[d(" 更新标题 ")])),_:2},1032,["onClick"])]),_:1}),l(i,{fixed:"right",label:"操作",width:"100",align:"center"},{default:o(({row:s})=>[l(n,{type:"danger",plain:"",onClick:P=>z(s.id)},{default:o(()=>e[6]||(e[6]=[d(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),l(h,{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=s=>m.value=s),title:V.value,width:"500"},{footer:o(()=>[C("div",Y,[l(n,{onClick:e[1]||(e[1]=s=>m.value=!1)},{default:o(()=>e[7]||(e[7]=[d("取消")])),_:1}),l(n,{type:"primary",onClick:L},{default:o(()=>e[8]||(e[8]=[d(" 更新 ")])),_:1})])]),default:o(()=>[l(k,null,{default:o(()=>[l(_,{label:"标题"},{default:o(()=>[l(g,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=s=>v.value=s)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])],64)}}};export{de as default};
